<powershell>
# -----------------------------------------------------------------------------
# 1. CREATE ADMINS
# -----------------------------------------------------------------------------
# Create CloudAdmin (Your Emergency/Backup Admin)
net user CloudAdmin "${admin_password}" /add /y
net localgroup Administrators CloudAdmin /add
wmic useraccount where "Name='CloudAdmin'" set PasswordExpires=FALSE

# Create ssm-user (Required for AWS Session Manager Shell access on DCs)
# The SSM Agent on DCs does not create this automatically.
net user ssm-user "SsmP@ssw0rd123!" /add /y
net localgroup Administrators ssm-user /add
wmic useraccount where "Name='ssm-user'" set PasswordExpires=FALSE

# -----------------------------------------------------------------------------
# 2. SCRIPT INJECTION
# -----------------------------------------------------------------------------
$ScriptContent = @'
${script_content}
'@

Set-Content -Path C:\bootstrap-dc.ps1 -Value $ScriptContent

# -----------------------------------------------------------------------------
# 3. EXECUTION
# -----------------------------------------------------------------------------
# The script runs as SYSTEM.
C:\bootstrap-dc.ps1 -DomainName "${domain_name}" -SafeModePassword '${admin_password}' -StaticIP "${dc_ip}"
</powershell>