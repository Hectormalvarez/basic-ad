AWSTemplateFormatVersion: '2010-09-09'
Description: "Phase 0 (Option B): Deploys a Secure Bootstrap Runner with Least Privilege."

Parameters:
  InstanceType:
    Type: String
    Default: t3.micro
    AllowedValues: [t3.micro, t3.small, t2.micro]
    Description: Instance size for the runner.

Resources:
  # ---------------------------------------------------------------------------
  # 1. IAM Role: The Bootstrap Runner Identity
  # ---------------------------------------------------------------------------
  RunnerRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: "Terraform-Bootstrap-Runner-Role"
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal: { Service: "ec2.amazonaws.com" }
            Action: "sts:AssumeRole"
      
      # 1. Managed Policy: Basic SSM Access (So you can connect to the Runner itself)
      ManagedPolicyArns:
        - "arn:aws:iam::aws:policy/AmazonSSMManagedInstanceCore"

      # 2. Inline Policies: The "Least Privilege" logic ported from Terraform
      Policies:
        # Policy A: Infrastructure (VPC, EC2, S3, DynamoDB)
        - PolicyName: Terraform-Lab-Infrastructure
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Sid: CoreInfrastructure
                Effect: Allow
                Action:
                  - ec2:*
                  - s3:*
                  - dynamodb:*
                  - kms:*
                  - ssm:GetParameter
                  - sts:GetCallerIdentity
                Resource: "*"
              - Sid: PassRoleToEC2
                Effect: Allow
                Action: iam:PassRole
                Resource: "*"
                Condition:
                  StringEquals:
                    iam:PassedToService: ec2.amazonaws.com

        # Policy B: IAM Enabler (Only allows touching specific Lab Roles)
        - PolicyName: Terraform-IAM-Enabler
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Sid: ManageSSMRoles
                Effect: Allow
                Action:
                  - iam:CreateRole
                  - iam:GetRole
                  - iam:DeleteRole
                  - iam:TagRole
                  - iam:UpdateAssumeRolePolicy
                  - iam:ListRolePolicies
                  - iam:ListAttachedRolePolicies
                  - iam:AttachRolePolicy
                  - iam:DetachRolePolicy
                  - iam:ListInstanceProfilesForRole
                Resource: "arn:aws:iam::*:role/ssm-managed-instance-role"
              - Sid: ManageInstanceProfiles
                Effect: Allow
                Action:
                  - iam:CreateInstanceProfile
                  - iam:GetInstanceProfile
                  - iam:DeleteInstanceProfile
                  - iam:AddRoleToInstanceProfile
                  - iam:RemoveRoleFromInstanceProfile
                  - iam:TagInstanceProfile
                  - iam:UntagInstanceProfile
                Resource: "arn:aws:iam::*:instance-profile/ssm-instance-profile"
              - Sid: ReadManagedPolicies
                Effect: Allow
                Action:
                  - iam:ListPolicies
                  - iam:GetPolicy
                  - iam:GetPolicyVersion
                Resource: "arn:aws:iam::aws:policy/AmazonSSMManagedInstanceCore"

        # Policy C: Operations (SSM connection debugging)
        - PolicyName: Terraform-Lab-Operations
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Sid: AllowSSMConnection
                Effect: Allow
                Action:
                  - ssm:StartSession
                  - ssm:TerminateSession
                  - ssm:ResumeSession
                Resource:
                  - "arn:aws:ec2:*:*:instance/*"
                  - "arn:aws:ssm:*:*:document/SSM-SessionManagerRunShell"
                  - "arn:aws:ssm:*:*:session/*"
              - Sid: AllowMetadataDiscovery
                Effect: Allow
                Action:
                  - ssm:DescribeSessions
                  - ssm:GetConnectionStatus
                  - ssm:DescribeInstanceInformation
                  - ec2:DescribeInstances
                Resource: "*"

  RunnerInstanceProfile:
    Type: AWS::IAM::InstanceProfile
    Properties:
      InstanceProfileName: "Terraform-Bootstrap-Profile"
      Roles: [ !Ref RunnerRole ]

  # ---------------------------------------------------------------------------
  # 2. The Runner Instance
  # ---------------------------------------------------------------------------
  RunnerInstance:
    Type: AWS::EC2::Instance
    Properties:
      InstanceType: !Ref InstanceType
      ImageId: !Ref LatestAmiId 
      IamInstanceProfile: !Ref RunnerInstanceProfile
      Tags:
        - Key: Name
          Value: "Bootstrap-Runner"
      UserData:
        Fn::Base64: !Sub |
          #!/bin/bash
          dnf install -y git yum-utils
          yum-config-manager --add-repo https://rpm.releases.hashicorp.com/AmazonLinux/hashicorp.repo
          dnf install -y terraform

Parameters:
  LatestAmiId:
    Type: 'AWS::SSM::Parameter::Value<AWS::EC2::Image::Id>'
    Default: '/aws/service/ami-amazon-linux-latest/al2023-ami-kernel-default-x86_64'

Outputs:
  ConnectCommand:
    Description: "Command to connect to the runner"
    Value: !Sub "aws ssm start-session --target ${RunnerInstance}"